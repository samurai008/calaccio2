<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/Actions/PortalAuthActions.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="..\..\prettify.css" />
    <link rel="stylesheet" href="..\..\base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(..\..\sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="..\..\index.html">All files</a> / <a href="index.html">src/Actions</a> PortalAuthActions.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">78.38% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>29/37</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">73.68% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>28/38</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">82.35% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>28/34</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">116x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">116x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import AppDispatcher from '../Dispatchers/AppDispatcher';
import ConfigStore from '../Stores/ConfigStore';
import request from 'superagent';
import {_deleteCookie} from '../Containers/App.jsx';
&nbsp;
/**
 * flux actions to perform against the portal server
 * @type PortalAuthActions
 */
const languageMap = {
		"en": "en_US",
		"es": "es_ES"
	};
var PortalAuthActions = {
	refreshAuthToken: function() {
		var endpoint = ConfigStore.getURL('authTokenEndpoint');
		//console.log('refreshing auth token');
		// do nothing if we don't have an endpoint in this config
		<span class="missing-if-branch" title="if path not taken" >I</span>if(endpoint == null) <span class="cstat-no" title="statement not covered" >return;</span>
		
		/* parse devUserRole into jwt token endpoint URl for dev */
		<span class="missing-if-branch" title="if path not taken" >I</span>if(process.env.appConfig === "development") {
<span class="cstat-no" title="statement not covered" >			endpoint = endpoint.replace('{role}', ConfigStore.get('devUserRole'));</span>
		}
		
		//adding below code to avoid reset ahbx_locale cookie value from LocaleFilter
		var matchCookie = document.cookie.match(/(^|;)\s*ahbx_locale\s*=\s*([^;]+)/),
		matched = (matchCookie) ? <span class="branch-0 cbranch-no" title="branch not covered" >matchCookie.pop() </span>: 'en',
		selectedLanguage = (matched === 'en' || <span class="branch-1 cbranch-no" title="branch not covered" >matched === 'es')</span> ? matched : <span class="branch-1 cbranch-no" title="branch not covered" >'en';</span>
		
		
		//note: X-Pageview-Id and X-Correlation-Id are not sent with the JWT request as there seems to be
		//an issue with the CORS filters in Portal that is blocking the OPTIONS with these headers
		request
			.get(endpoint)
			.query({lang : languageMap[selectedLanguage]})
			.withCredentials()
			.redirects(0)
			.end((err, response) =&gt; {
				if(!err &amp;&amp; response &amp;&amp; response.status === 200 &amp;&amp; response.body){
					if(typeof response.body.timeshifterEnabledForUser !== "undefined" 
						&amp;&amp; response.body.timeshifterEnabledForUser == 'true') {
						<span class="missing-if-branch" title="if path not taken" >I</span>if(process.env.appConfig === 'development') {
<span class="cstat-no" title="statement not covered" >							console.log("Timeshifter enabled for user!");</span>
						}
						let timeshifterPayload = {
							timeshifterEnabledForUser : response.body.timeshifterEnabledForUser,
							timeshifterOffsetMillis : response.body.timeshifterOffsetMillis,
							shiftedDateMillisFromEpoch : response.body.shiftedDateMillisFromEpoch
						};
						this.dispatch('TIMESHIFTER_REFRESH_FROM_SERVER', timeshifterPayload);
					}
					else{
						<span class="missing-if-branch" title="if path not taken" >I</span>if(process.env.appConfig === 'development') {
<span class="cstat-no" title="statement not covered" >							console.log("Timeshifter NOT enabled for user");</span>
						}
					}
					if(response.body.encodedToken) {
							return this.dispatch('AUTH_TOKEN_REFRESH_FROM_SERVER', response.body.encodedToken);
					}
				}
				let redirectUrl = ConfigStore.getURL('portalSignoutURL');
				// avoid doing this redirect if test mode was detected
				<span class="missing-if-branch" title="else path not taken" >E</span>if(redirectUrl === null || process.env.NODE_ENV === 'test' || <span class="branch-2 cbranch-no" title="branch not covered" >window.location.href === 'about:blank')</span> return;
				// redirect to OAM login 
				// removed the if conditional, since the session will always be invalid at this point in the code, and should always be
				// redirected to the portal
<span class="cstat-no" title="statement not covered" >				_deleteCookie('pendingAppId');</span>
<span class="cstat-no" title="statement not covered" >				_deleteCookie('enrollmentYear');</span>
<span class="cstat-no" title="statement not covered" >				window.location.href = redirectUrl;</span>
			});
	},
	refreshPortalSession: function() {
		var endpoint = ConfigStore.getURL('extendSessionEndpoint'),
			// needed since this runs on an interval losing context
			dispatch = (type) =&gt; {
				AppDispatcher.dispatch({
							action: {
								type: type,
								payload: null
							}
						})
			};
		//console.log('refreshing portal session');
		// do nothing if we don't have an endpoint in this config
		<span class="missing-if-branch" title="if path not taken" >I</span>if(endpoint == null) <span class="cstat-no" title="statement not covered" >return;</span>
		request
			.get(endpoint)
			.withCredentials()
			.redirects(0)
			.end((err, response) =&gt; {
				if(!err &amp;&amp; response &amp;&amp; response.status === 200) {
					return dispatch('PORTAL_SESSION_REFRESH');
				}
				dispatch('OTHER_ERROR');
			});
	},
	dispatch: (actionType, data) =&gt; {
		// Dispatch the event, the appropriate Stores will do the rest.
		AppDispatcher.dispatch({
			action: {
				type: actionType,
				payload: data
			}
		});
	}
};
&nbsp;
export default PortalAuthActions;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Mon Sep 11 2017 19:27:49 GMT+0530 (India Standard Time)
</div>
</div>
<script src="..\..\prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="..\..\sorter.js"></script>
</body>
</html>
